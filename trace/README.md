# ioctl tracer

This is a collection of scripts that allow you to trace and pretty-print the
`ioctl()` calls made `libMali.so`. To use them, you must have a Mali-Txxx GPU
that uses the `gpu/arm/midgard` kernel driver and a compatible version of
`libMali.so`.

## Trace Setup

* Hisense Chromebook C11 (though any other RK3288-based chromebook should do)
* [Arch Linux ARM][alarm-veyron]
* libMali r5p0-14wk51 from the [veyron-libgl][veyron-libgl] package
* [xf86-video-armsoc-rockchip][xf86-video-armsoc-rockchip]
* lxdm (because for some reason X wouldn't work without a display manager, and
  lxdm worked out-of-the-box)
* i3 Window Manager (you really just need some kind of WM--any one should do)
* [frida-server][frida-server]: This is run on the Chromebook
* [frida-trace][frida-trace]: This is run on your development machine

Once you have Arch up and running on the Chromebook, you're logged into a
desktop session, and have the Chomebook connected to the same network as your
dev PC, you can start the `frida-server` with the following command:

    $ ./frida-server -l 0.0.0.0

This of course, assumes you're currently in the same directory as the
`frida-server` binary and want to listen on all interfaces. If you'd rather
everyone on your local network *not* have the ability to run arbitrary commands
on your Chromebok, omit the `-l 0.0.0.0` and use an SSH tunnel to `frida-server`
instead.

With `frida-server` running, `cd` to the directory the \_\_handlers\_\_
directory is in (the same as this README file) and run the following command:

    $ frida-trace -i ioctl -i open -H x.x.x.x /usr/bin/es2_info

You should replace `x.x.x.x` with the IP address of the Chromebook (or the SSH
tunnel if you're using one) and `/usr/bin/es2_info` with the full path to the
binary on the Chromebook that you want to trace.

When you run the previous command, you should start seeing output from the
various trace handlers. If you aren't, your versions of `libc` and `libpthread`
may be different from ones these scrips were generated from. To fix this,
simply move the `*.js` files from the directories with the older versions to the
new ones that should have been automatically-generated by `frida-trace`.

[alarm-veyron]: https://archlinuxarm.org/platforms/armv7/rockchip/hisense-chromebook-c11
[veyron-libgl]: https://github.com/archlinuxarm/PKGBUILDs/tree/master/alarm/veyron-libgl
[xf86-video-armsoc-rockchip]: https://github.com/archlinuxarm/PKGBUILDs/tree/master/alarm/xf86-video-armsoc-rockchip
[frida-server]: https://build.frida.re/frida/linux/armhf/bin/frida-server
[frida-trace]: http://www.frida.re/
